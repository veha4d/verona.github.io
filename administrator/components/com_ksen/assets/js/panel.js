function clog(a){console.log(a)}var current_body_width,current_body_height,last_body_width,last_body_height,selected_widget=0;jQuery(function(){metro_ui.init(),jQuery("#metro-ui").mousewheel(function(a,b){this.scrollLeft=this.scrollLeft-30*b,a.preventDefault()}),jQuery(window).on("resize",function(){if(current_body_width=jQuery("body").width(),current_body_height=jQuery(window).height()-metro_ui.cut_height,current_body_width!=last_body_width||current_body_height!=last_body_height){if(current_body_height!=last_body_height){clog("resize");var a=parseInt(current_body_height/metro_ui.height_one_widget);metro_ui.max_block_height=a*metro_ui.height_one_widget,metro_ui.max_block_deposit=metro_ui.max_block_height/metro_ui.height_one_widget,jQuery(".metro-ui-inner").height(metro_ui.max_block_height);for(var b=current_body_height>last_body_height?"checkDeficit":"checkExcess",c=jQuery(".widgets:first");c.length;)c.hasClass("widgets")?(metro_ui[b](c,1),c=c.next()):c=c.next();metro_ui.init_sortable(),metro_ui.init_resizable(),metro_ui.refresh_metro_ui_width(),metro_ui.updateMargin(),metro_ui.max_metro_width=metro_ui.metro_inner_block.width()}else metro_ui.refresh_metro_ui_width();last_body_width=current_body_width,last_body_height=current_body_height}}),jQuery("#remove_widget").click(function(){return selected_widget?(jQuery('.widgets a[id="'+selected_widget+'"]').remove(),jQuery("#edit-panel").hide(),!1):void 0})});var metro_ui={metro_block:null,metro_inner_block:null,max_block_height:0,max_metro_width:0,current_metro_width:0,cut_height:250,max_block_deposit:0,refresh_plugins:0,right_metro_width:0,height_one_widget:160,block_sender:null,block_hover:null,marginHeight:0,scrollHeight:15,extension:null,active_blocks:[null,null],init:function(){last_body_width=jQuery("body").width(),last_body_height=jQuery(window).height()-metro_ui.cut_height,metro_ui.metro_block=jQuery("#metro-ui"),metro_ui.extension=metro_ui.metro_block.attr("rel");var a=parseInt(last_body_height/metro_ui.height_one_widget);metro_ui.max_block_height=a*metro_ui.height_one_widget,metro_ui.max_block_deposit=metro_ui.max_block_height/metro_ui.height_one_widget,metro_ui.metro_inner_block=jQuery(".metro-ui-inner"),metro_ui.metro_inner_block.height(metro_ui.max_block_height);for(var b=last_body_height>metro_ui.metro_block.height()?"checkDeficit":"checkExcess",c=jQuery(".widgets:first");c.length;)c.hasClass("widgets")?(metro_ui[b](c,1),c=c.next()):c=c.next();metro_ui.init_sortable(),metro_ui.init_droppable(),metro_ui.init_resizable(),metro_ui.max_metro_width=metro_ui.metro_inner_block.width(),metro_ui.refresh_metro_ui_width(),metro_ui.updateMargin()},updateMargin:function(){this.marginHeight=jQuery(window).height()-metro_ui.cut_height-metro_ui.scrollHeight-this.max_block_height,this.marginHeight<0||(jQuery("#metro_margin").length?jQuery("#metro_margin").height(this.marginHeight):this.metro_inner_block.after('<div id="metro_margin" style="height:'+this.marginHeight+'px;"></div>'))},refresh_metro_ui_width:function(){this.max_metro_width=this.metro_block.width(),this.current_metro_width=3,jQuery(".widgets").each(function(){metro_ui.current_metro_width+=jQuery(this).outerWidth(!0)}),jQuery(".margins").each(function(){metro_ui.current_metro_width+=jQuery(this).outerWidth(!0)}),this.right_metro_width=this.current_metro_width>this.max_metro_width?this.current_metro_width:"auto",this.metro_inner_block.width(this.right_metro_width)},getWidgetClass:function(a){var b="standart";return a.hasClass("double")?b="double":a.hasClass("half")&&(b="half"),b},getWidgetDeposit:function(a){var b=0;switch(a){case"double":b=1;break;case"standart":b=.5;break;case"half":b=.25}return b},witoutEmty:function(a){a||(a=this.block_sender),a.find("a").length||(left=a.prev(),right=a.next(),a.remove(),(!left||left.hasClass("margins"))&&right&&right.hasClass("margins")&&right.remove())},init_sortable:function(){jQuery(".widgets").sortable({connectWith:".widgets",helper:"original",tolerance:"intersect",placeholder:!1,forcePlaceholderSize:!1,start:function(a,b){metro_ui.block_sender=jQuery(a.target),metro_ui.active_blocks[0]=metro_ui.block_sender.get(0),jQuery(".widgets a").addClass("no-moved"),jQuery(".margins").addClass("moved"),b.item.removeClass("no-moved").addClass("moved"),metro_ui.refresh_metro_ui_width()},change:function(){metro_ui.checkDeficit(jQuery(metro_ui.active_blocks[0])),metro_ui.checkExcess(jQuery(metro_ui.active_blocks[1]))},over:function(a){2==metro_ui.active_blocks.length&&metro_ui.active_blocks.slice(0,1),metro_ui.active_blocks[1]=jQuery(a.target).get(0)},stop:function(){jQuery(".widgets a").removeClass("moved").removeClass("no-moved"),jQuery(".margins").removeClass("moved").removeClass("ui-droppable"),metro_ui.refresh_plugins&&(metro_ui.init_sortable(),metro_ui.init_droppable(),metro_ui.init_resizable(),metro_ui.refresh_plugins=0),metro_ui.witoutEmty(),metro_ui.refresh_metro_ui_width(),metro_ui.block_sender=null,metro_ui.active_blocks=[null,null],metro_ui.saveUserConfig()}}).disableSelection()},init_droppable:function(){jQuery(".margins").droppable({tolerance:"intersect",over:function(a){metro_ui.block_hover=jQuery(a.target),metro_ui.block_hover.addClass("margin-active")},out:function(){metro_ui.block_hover.removeClass("margin-active")},drop:function(a,b){var c='<div class="margins"></div>',d=b.draggable;d.removeAttr("style").removeClass("ui-sortable-helper"),metro_ui.block_hover.replaceWith(c+'<div class="widgets">'+d.get(0).outerHTML+"</div>"+c),b.draggable.remove(),metro_ui.witoutEmty(),metro_ui.refresh_plugins=1}}).disableSelection()},init_resizable:function(){jQuery(".widgets a").resizable({helper:"metroui-widget-resizable-helper",maxHeight:159,maxWidth:319,minHeight:159,minWidth:159,stop:function(a,b){var c=metro_ui.getWidgetClass(jQuery(this)),d=b.size.width>240?"double":"standart";jQuery(this).removeAttr("style"),d!=c&&(jQuery(this).removeClass(c).addClass(d),"double"==d?metro_ui.checkExcess(jQuery(this).parent()):(metro_ui.checkDeficit(jQuery(this).parent().prev()),metro_ui.checkDeficit(jQuery(this).parent())),metro_ui.refresh_plugins&&(metro_ui.init_sortable(),metro_ui.init_droppable(),metro_ui.refresh_plugins=0),metro_ui.init_resizable(),metro_ui.refresh_metro_ui_width(),metro_ui.saveUserConfig())}}).disableSelection()},checkDeficit:function(a){var b=a.next();if(b.hasClass("linked")){var c=0,d=0,e="";if(a.find("a").each(function(){jQuery(this).hasClass("ui-sortable-helper")||(e=metro_ui.getWidgetClass(jQuery(this)),d=metro_ui.getWidgetDeposit(e),jQuery(this).next()&&"double"!=e&&(next_widget_deposit=metro_ui.getWidgetDeposit(metro_ui.getWidgetClass(jQuery(this).next())),0==c-parseInt(c)?d=next_widget_deposit>d?next_widget_deposit:d:"half"==e&&next_widget_deposit>d&&(d*=2)),c+=d)}),free_deposit=metro_ui.max_block_deposit-c){for(;free_deposit&&(desired_widget=b.find("a:first"),desired_widget_deposit=metro_ui.getWidgetDeposit(metro_ui.getWidgetClass(desired_widget)),!(desired_widget_deposit>free_deposit));)a.append(desired_widget.remove()),free_deposit-=desired_widget_deposit;metro_ui.witoutEmty(b)}}},checkExcess:function(a){var b=4;if(a.prop("scrollHeight")-b>metro_ui.max_block_height){var c=a.next();for(c.hasClass("linked")||(a.after('<div class="widgets linked ui-sortable"></div>'),c=a.next());a.prop("scrollHeight")-b>metro_ui.max_block_height;)excess_widget=a.find("a:last"),c.prepend(excess_widget.remove());metro_ui.refresh_plugins=1}},saveUserConfig:function(){var a={},b={},c={},d=0,e=0;jQuery(".widgets").each(function(){var a=jQuery(this);a.hasClass("linked")||e>0&&(b[d]=c,c={},d++,e=0),a.find("a").each(function(){var a=jQuery(this);if(a.hasClass("main"))var b="main";else if(a.hasClass("sub"))var b="sub";a.hasClass("double")&&(b+=",double"),c[a.attr("id")]=b}),e++}),b[d]=c,a.groups=b,a.extension=metro_ui.extension,a.task="panel.save_widgets_users_config",jQuery.ajax({url:"index.php?option=com_ksen",data:a,dataType:"json",success:function(a){0!=a.errors&&KMShowMessage(a.message.join("<br>"))}})}};